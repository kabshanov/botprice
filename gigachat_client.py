# gigachat_client.py
import time
import uuid
import requests

from gigachat_config import (
    GIGACHAT_AUTH_KEY,
    GIGACHAT_SCOPE,
    GIGACHAT_TOKEN_URL,
    GIGACHAT_API_BASE_URL,
)

# –ö—ç—à —Ç–æ–∫–µ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
_token_cache: dict[str, float | str | None] = {
    "access_token": None,
    "expires_at": 0.0,
}


def get_access_token() -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç (–∏ –∫—ç—à–∏—Ä—É–µ—Ç) access-token GigaChat.
    –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Ç–µ–∫—É—â–∏–π.
    """
    now_ms = time.time() * 1000
    if _token_cache["access_token"] and now_ms < _token_cache["expires_at"] - 30_000:
        return _token_cache["access_token"]  # type: ignore

    headers = {
        "Authorization": GIGACHAT_AUTH_KEY,
        "Content-Type":  "application/x-www-form-urlencoded",
        "Accept":        "application/json",
        "RqUID":         str(uuid.uuid4()),
    }
    data = {"scope": GIGACHAT_SCOPE}

    resp = requests.post(GIGACHAT_TOKEN_URL, headers=headers, data=data, verify=False)
    resp.raise_for_status()
    obj = resp.json()

    _token_cache.update(
        {
            "access_token": obj["access_token"],
            "expires_at":   obj["expires_at"],  # –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –æ—Ç —ç–ø–æ—Ö–∏
        }
    )
    return obj["access_token"]


def chat_completion(model: str, messages: list[dict]) -> str:
    """
    –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ POST /chat/completions.
    `messages` ‚Äî —Å–ø–∏—Å–æ–∫ dict‚Äô–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI/GigaChat API.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç content –∏–∑ –ø–µ—Ä–≤–æ–≥–æ choice.
    """
    token = get_access_token()
    url = f"{GIGACHAT_API_BASE_URL}/chat/completions"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type":  "application/json",
    }
    payload = {"model": model, "messages": messages}

    resp = requests.post(url, json=payload, headers=headers, verify=False)
    resp.raise_for_status()
    return resp.json()["choices"][0]["message"]["content"]


# ‚Äî‚Äî‚Äî System-prompt –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî‚Äî‚Äî
SYSTEM_PROMPT = {
    "role": "system",
    "content": (
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1. –û–±—â–∞—è —Ä–æ–ª—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        "–¢—ã ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤.\n"
        "–ù–∏–∂–µ —è –ø–µ—Ä–µ–¥–∞–º *–≠—Ç–∞–ª–æ–Ω* ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, "
        "–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤–∏–¥–µ—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç.\n\n"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 2. –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç—å –≠—Ç–∞–ª–æ–Ω, –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–µ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ "
        "–ø–æ—Ç–æ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –∫ *–ù–æ–≤–æ–º—É–°–æ–æ–±—â–µ–Ω–∏—é* (—Å—ã—Ä—ã–º —Ü–µ–Ω–∞–º), –Ω–µ —Ç–µ—Ä—è—è –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—è –ª–∏—à–Ω–µ–≥–æ.\n\n"

        # 2.1 –ö–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–¥–æ –≤—ã—Ç–∞—â–∏—Ç—å
        "–ò–∑–≤–ª–µ–∫–∏ –∏ –∑–∞–ø–æ–º–Ω–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ, –±–µ–∑ –≤—ã–≤–æ–¥–∞) –≤—Å—ë, —á—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è:\n"
        "‚Ä¢ –ø–æ—Ä—è–¥–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–π –±–ª–æ–∫–æ–≤/–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤;\n"
        "‚Ä¢ –Ω–∞–ª–∏—á–∏—è/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–±—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –±—Ä–µ–Ω–¥–æ–≤;\n"
        "‚Ä¢ —Å–∏–º–≤–æ–ª–∞-–º–∞—Ä–∫–µ—Ä–∞ (‚ñ™Ô∏è, ‚Ä¢, —ç–º–æ–¥–∑–∏, –¥—Ä.);\n"
        "‚Ä¢ –º–µ—Å—Ç, –≥–¥–µ —Å—Ç–æ—è—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏;\n"
        "‚Ä¢ –ª–æ–≥–∏–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (–æ–±—ä—ë–º –ø–∞–º—è—Ç–∏, Dual sim/eSim/LTE, –≥–æ–¥, –º–æ–¥–µ–ª—å –∏ —Ç.–¥.);\n"
        "‚Ä¢ –ø–æ—Ä—è–¥–∫–∞ –ø–æ–ª–µ–π –≤ —Å—Ç—Ä–æ–∫–µ (–º–æ–¥–µ–ª—å ‚Üí –æ–±—ä—ë–º ‚Üí —Ü–≤–µ—Ç ‚Üí –∞—Ç—Ä–∏–±—É—Ç—ã ‚Üí —Ü–µ–Ω–∞ ‚Üí —Ñ–ª–∞–≥ —Å—Ç—Ä–∞–Ω—ã);\n"
        "‚Ä¢ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø (–æ–±—ä—ë–º ‚Üë, —Ü–≤–µ—Ç A‚ÜíZ, –∏ –ø—Ä.).\n\n"

        # 2.2 –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ù–æ–≤—ã–º–°–æ–æ–±—â–µ–Ω–∏–µ–º
        "–ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∏—à—å –ù–æ–≤–æ–µ–°–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–µ–≤—Ä–∞—Ç–∏ –µ–≥–æ –≤ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∞–π—Å —Å—Ç—Ä–æ–≥–æ –ø–æ —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º. "
        "–ï—Å–ª–∏ —Ç–∞–º –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏/–æ–±—ä—ë–º—ã/–∞—Ç—Ä–∏–±—É—Ç—ã ‚Äî –ª–æ–≥–∏—á–Ω–æ –≤—Å—Ç–∞–≤—å –∏—Ö –≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã, "
        "—Å–æ–±–ª—é–¥–∞—è –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫.\n\n"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3. –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê-–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        "–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n"
        "‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É ( #, *, _, ‚Äî, -, +, —Ü–∏—Ñ—Ä—ã-—Ç–æ—á–∫–∏ ). –í—ã–≤–æ–¥–∏ —Ç–æ–ª—å–∫–æ plain-text.\n"
        "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π —Å–∏–º–≤–æ–ª—ã-–º–∞—Ä–∫–µ—Ä—ã –∏ —Ç–∏—Ä–µ —Ä–æ–≤–Ω–æ —Ç–∞–∫–∏–º–∏, –∫–∞–∫ –≤ –≠—Ç–∞–ª–æ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´‚ñ™Ô∏è¬ª –∏ ¬´‚Äì¬ª).\n"
        "‚Ä¢ –ù–µ –¥–æ–±–∞–≤–ª—è–π —Å–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –≠—Ç–∞–ª–æ–Ω–µ. –ù–µ –º–µ–Ω—è–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª (—Ç–æ—á–∫–∏‚Üî–∑–∞–ø—è—Ç—ã–µ, –ø—Ä–æ–±–µ–ª—ã-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏).\n"
        "‚Ä¢ –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞–≤—å **—Ç–æ–ª—å–∫–æ** –≤ —Ç–µ—Ö –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –æ–Ω–∏ –µ—Å—Ç—å –≤ –≠—Ç–∞–ª–æ–Ω–µ.\n"
        "‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥-–≥—Ä—É–ø–ø—ã –≤—ã–≤–æ–¥–∏ –æ–¥–∏–Ω —Ä–∞–∑; –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö —Ç–æ–π –∂–µ –ø–æ–¥-–≥—Ä—É–ø–ø—ã –Ω–µ –¥—É–±–ª–∏—Ä—É–π –µ–≥–æ.\n"
        "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —ç–º–æ–¥–∑–∏-—Ñ–ª–∞–≥–∏, –∫–∞–≤—ã—á–∫–∏ (\" vs ‚Äù), –¥—é–π–º–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª—é–±—ã–µ —Å–ø–µ—Ü-–∑–Ω–∞–∫–∏ –∫–∞–∫ –µ—Å—Ç—å.\n"
        "‚Ä¢ –ù–µ –≤—ã–≤–æ–¥–∏ –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ –∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ (–Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –æ–ø–∏—Å–∞–Ω–∏–π –ø—Ä–∞–≤–∏–ª –∏ —Ç.–ø.).\n\n"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 4. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        "–ü—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –ª—é–±—ã—Ö —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã, –ø–ª–∞–Ω—à–µ—Ç—ã, –Ω–æ—É—Ç–±—É–∫–∏, —á–∞—Å—ã, –∞—É–¥–∏–æ –∏ –¥—Ä.\n"
        "–ï—Å–ª–∏ –≤ –≠—Ç–∞–ª–æ–Ω–µ –Ω–µ—Ç –æ–±—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–π –µ–≥–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –ù–æ–≤–æ–º–°–æ–æ–±—â–µ–Ω–∏–∏.\n"
    ),
}



# ‚Äî‚Äî‚Äî –ú–∏–Ω–∏-—Å–∞–º–æ—Ç–µ—Å—Ç ‚Äî‚Äî‚Äî
if __name__ == "__main__":
    raw_text = """
APPLE IPHONE
iPhone 16 Pro
16 Pro 128 Black ‚Äì 83.400 üá¶üá™
16 Pro 128 Desert ‚Äì 81.300 üá¶üá™
16 Pro 128 Desert Dual sim ‚Äì 81.100 üá®üá≥
16 Pro 128 Black eSim ‚Äì 75.100 üá∫üá∏
"""
    dialog = [SYSTEM_PROMPT, {"role": "user", "content": raw_text}]
    print(chat_completion("GigaChat-Pro", dialog))
